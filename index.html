<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tin Tức Logistics Mới Nhất</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Sử dụng font Inter */
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        /* CSS cho hiệu ứng loading spinner */
        .loader {
            border: 5px solid #f3f3f3; /* Light grey */
            /* Cập nhật màu spinner cho hợp với theme */
            border-top: 5px solid #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Cập nhật kiểu cho nút tab */
        .tab-active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            font-weight: 600;
            /* Thêm hiệu ứng nổi bật */
            transform: scale(1.05);
            box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.3);
        }
        .tab-inactive {
            background-color: white;
            color: #374151; /* gray-700 */
            /* Thêm viền và bóng mờ */
            border: 1px solid #d1d5db; /* gray-300 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
    </style>
    <!-- Tải font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<!-- Thêm nền gradient tinh tế -->
<body class="bg-gradient-to-br from-gray-50 to-blue-100 min-h-screen">

    <div class="container mx-auto max-w-4xl p-4 md:p-8">
        <!-- Tiêu đề được làm nổi bật hơn -->
        <header class="mb-8 text-center">
            <h1 class="text-4xl md:text-5xl font-extrabold bg-gradient-to-r from-blue-600 to-indigo-800 bg-clip-text text-transparent pb-2">
                Tin Tức Logistics Mới Nhất
            </h1>
            <p class="text-gray-700 mt-2 text-lg">
                Cập nhật tin tức mới nhất từ trong nước và quốc tế.
            </p>
        </header>

        <!-- Các nút chọn với hiệu ứng transition -->
        <nav class="flex justify-center space-x-4 mb-8">
            <button id="domesticBtn" class="px-6 py-3 rounded-lg transition-all duration-300 ease-in-out tab-active">
                Trong Nước
            </button>
            <button id="internationalBtn" class="px-6 py-3 rounded-lg transition-all duration-300 ease-in-out tab-inactive">
                Quốc Tế
            </button>
        </nav>

        <!-- Khu vực hiển thị nội dung -->
        <main id="contentArea">
            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="loader" style="display: none;"></div>
            
            <!-- Hiển thị lỗi -->
            <div id="errorMessage" class="hidden text-center text-red-600 bg-red-100 p-4 rounded-lg shadow-md">
                <!-- Nội dung lỗi sẽ được chèn vào đây -->
            </div>

            <!-- Nội dung tin tức -->
            <div id="newsContent" class="space-y-5">
                <!-- Tin tức sẽ được chèn vào đây -->
            </div>

            <!-- Nguồn tin (từ Google Search) -->
            <div id="sourcesContainer" class="hidden mt-10 border-t-2 border-gray-200 pt-6">
                <h3 class="font-semibold text-xl text-gray-800 mb-4">Nguồn tin tham khảo:</h3>
                <ul id="sourcesList" class="list-disc list-inside text-sm text-blue-600 space-y-2">
                    <!-- Nguồn sẽ được chèn vào đây -->
                </ul>
            </div>
        </main>
    </div>

    <script>
        // Lấy các phần tử DOM
        const domesticBtn = document.getElementById('domesticBtn');
        const internationalBtn = document.getElementById('internationalBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const newsContent = document.getElementById('newsContent');
        const errorMessage = document.getElementById('errorMessage');
        const sourcesContainer = document.getElementById('sourcesContainer');
        const sourcesList = document.getElementById('sourcesList');

        // Khóa API (Để trống, Canvas sẽ tự động cung cấp)
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // System prompt cho mô hình Gemini
        const systemPrompt = `Bạn là một biên tập viên tin tức logistics chuyên nghiệp.
Hãy trả về 5 tin tức mới nhất dựa trên truy vấn của người dùng.
ĐỊNH DẠNG TRẢ LỜI BẮT BUỘC:
Mỗi tin tức phải theo cấu trúc sau, cách nhau bởi dấu ||:
Tiêu đề: [Tiêu đề tin tức]||Tóm tắt: [Tóm tắt ngắn gọn trong 1-2 câu]||Nguồn: [Tên nguồn tin]||URL: https://webnhanh.vn/resources/theme/web-khac/
Các tin tức phải cách nhau bằng một dòng mới.
KHÔNG thêm bất kỳ lời chào, lời dẫn hay kết luận nào. Chỉ trả về dữ liệu tin tức.`;

        /**
         * Hàm gọi API với cơ chế thử lại (exponential backoff)
         */
        async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    // Nếu lỗi do máy chủ (5xx) hoặc quá tải (429), thử lại
                    if (response.status === 429 || response.status >= 500) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                    // Các lỗi khác (4xx) thì không thử lại
                    const errData = await response.json();
                    throw new Error(errData.error?.message || `Lỗi ${response.status}`);
                }
                return response.json();
            } catch (error) {
                if (retries > 0) {
                    // Chờ và thử lại
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                } else {
                    // Hết số lần thử
                    console.error("API call failed after retries:", error);
                    throw error;
                }
            }
        }

        /**
         * Hàm lấy tin tức từ Gemini API
         */
        async function fetchNews(query) {
            // 1. Đặt trạng thái tải
            setLoadingState(true);

            // 2. Xây dựng payload
            const payload = {
                contents: [{ parts: [{ text: query }] }],
                tools: [{ "google_search": {} }], // Bật Google Search
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            // 3. Gọi API
            try {
                const result = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const textResponse = candidate.content.parts[0].text;
                    const newsArray = parseNewsText(textResponse);
                    
                    // Lấy nguồn từ metadata
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attr => ({
                                uri: attr.web?.uri,
                                title: attr.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    displayNews(newsArray, sources);
                } else {
                    throw new Error("Không nhận được nội dung tin tức hợp lệ từ API.");
                }
            } catch (error) {
                console.error("Lỗi khi lấy tin tức:", error);
                displayError("Rất tiếc, đã xảy ra lỗi khi tải tin tức. Vui lòng thử lại sau.");
            } finally {
                // 4. Tắt trạng thái tải
                setLoadingState(false);
            }
        }

        /**
         * Hàm phân tích văn bản trả về từ API thành mảng object
         */
        function parseNewsText(text) {
            const articles = [];
            const lines = text.split('\n').filter(line => line.trim().length > 0);

            for (const line of lines) {
                const parts = line.split('||');
                // Yêu cầu 4 phần (Tiêu đề, Tóm tắt, Nguồn, URL)
                if (parts.length === 4) {
                    try {
                        const title = parts[0].replace('Tiêu đề:', '').trim();
                        const summary = parts[1].replace('Tóm tắt:', '').trim();
                        const source = parts[2].replace('Nguồn:', '').trim();
                        const urlPart = parts[3].replace('URL:', '').trim();
                        
                        // Chỉ lấy url nếu nó bắt đầu bằng http, ngược lại dùng '#'
                        const url = (urlPart.startsWith('http')) ? urlPart : '#';
                        
                        if (title && summary) { // Nguồn có thể không có
                            articles.push({ title, summary, source, url });
                        }
                    } catch (e) {
                        console.warn("Bỏ qua dòng định dạng không chính xác:", line);
                    }
                } else {
                    console.warn("Định dạng dòng không mong đợi (cần 4 phần):", line);
                }
            }
            return articles;
        }

        /**
         * Hàm hiển thị tin tức lên giao diện
         */
        function displayNews(newsArray, sources) {
            newsContent.innerHTML = ''; // Xóa nội dung cũ

            if (newsArray.length === 0) {
                newsContent.innerHTML = `<p class="text-center text-gray-500">Không tìm thấy tin tức nào.</p>`;
            }

            newsArray.forEach(news => {
                const card = document.createElement('article');
                // Cập nhật class cho card tin tức
                const hasLink = news.url && news.url !== '#';
                card.className = `bg-white p-5 rounded-lg shadow-lg border-l-4 border-blue-500 transition-all duration-300 hover:shadow-xl ${hasLink ? 'hover:scale-[1.02]' : 'hover:scale-[1.01]'}`;
                
                let titleElement;
                if (hasLink) {
                    // Nếu có link, làm cho tiêu đề có thể nhấp
                    titleElement = `
                        <a href="${news.url}" target="_blank" rel="noopener noreferrer" class="block text-xl font-semibold text-indigo-700 mb-2 hover:text-blue-600 hover:underline">
                            ${news.title}
                        </a>
                    `;
                } else {
                    // Nếu không có link, chỉ là văn bản
                    titleElement = `
                        <h2 class="text-xl font-semibold text-indigo-700 mb-2">${news.title}</h2>
                    `;
                }

                // Cập nhật HTML bên trong card
                card.innerHTML = `
                    ${titleElement}
                    <p class="text-gray-700 mb-4">${news.summary}</p>
                    ${news.source ? `<div class="mt-3"><span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-xs font-medium">Nguồn: ${news.source}</span></div>` : ''}
                `;
                newsContent.appendChild(card);
            });

            // Hiển thị nguồn tham khảo
            displaySources(sources);
        }

        /**
         * Hiển thị nguồn tham khảo từ groundingMetadata
         */
        function displaySources(sources) {
            sourcesList.innerHTML = ''; // Xóa nguồn cũ
            if (sources.length > 0) {
                sourcesContainer.classList.remove('hidden');
                sources.forEach(source => {
                    const li = document.createElement('li');
                    // Thêm style cho nguồn
                    li.innerHTML = `<a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline">${source.title}</a>`;
                    sourcesList.appendChild(li);
                });
            } else {
                sourcesContainer.classList.add('hidden');
            }
        }

        /**
         * Hàm đặt trạng thái tải (loading)
         */
        function setLoadingState(isLoading) {
            if (isLoading) {
                loadingSpinner.style.display = 'block';
                newsContent.innerHTML = ''; // Xóa tin tức cũ
                errorMessage.classList.add('hidden'); // Ẩn lỗi
                sourcesContainer.classList.add('hidden'); // Ẩn nguồn
            } else {
                loadingSpinner.style.display = 'none';
            }
        }

        /**
         * Hàm hiển thị thông báo lỗi
         */
        function displayError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            newsContent.innerHTML = ''; // Đảm bảo không có tin tức nào hiển thị
        }

        /**
         * Hàm cập nhật giao diện nút tab
         */
        function updateTabs(activeTab) {
            if (activeTab === 'domestic') {
                domesticBtn.classList.replace('tab-inactive', 'tab-active');
                internationalBtn.classList.replace('tab-active', 'tab-inactive');
            } else {
                internationalBtn.classList.replace('tab-inactive', 'tab-active');
                domesticBtn.classList.replace('tab-active', 'tab-inactive');
            }
        }

        // Thêm sự kiện click cho các nút
        domesticBtn.addEventListener('click', () => {
            updateTabs('domestic');
            fetchNews("Tin tức logistics mới nhất tại Việt Nam");
        });

        internationalBtn.addEventListener('click', () => {
            updateTabs('international');
            fetchNews("Tin tức logistics quốc tế mới nhất");
        });

        // Tải tin tức trong nước khi trang vừa mở
        window.addEventListener('load', () => {
            fetchNews("Tin tức logistics mới nhất tại Việt Nam");
        });

    </script>
</body>
</html>


